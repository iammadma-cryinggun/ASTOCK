//@version=5
indicator("ç»“æž„å¼ åŠ›æ¨¡åž‹ (Structural Tension)", overlay=false, max_boxes_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“Š ç»“æž„å¼ åŠ›æ¨¡åž‹ - TradingView ç‰ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// æ ¸å¿ƒæ€æƒ³ï¼š
// å°†ä»·æ ¼æ³¢åŠ¨æ˜ å°„åˆ°"å¼ åŠ›"æŒ‡æ ‡ï¼Œé€šè¿‡å¼ åŠ›çš„æ‹ç‚¹è¯†åˆ«ä¹°å–ä¿¡å·ã€‚
//
// ç”±äºŽ Pine Script ä¸æ”¯æŒå®Œæ•´çš„ FFT å’Œ Hilbert å˜æ¢ï¼Œ
// æœ¬æŒ‡æ ‡ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿‘ä¼¼ï¼š
// 1. å¯¹æ•°æ”¶ç›ŠçŽ‡ï¼ˆæ ‡å‡†åŒ–ï¼‰
// 2. å¤šå±‚å¹³æ»‘ï¼ˆæ¨¡æ‹Ÿé¢‘åŸŸæ»¤æ³¢ï¼‰
// 3. åŠ¨é‡æŒ¯è¡ï¼ˆæ¨¡æ‹Ÿå¼ åŠ›ï¼‰
// 4. æ»šåŠ¨çª—å£ï¼ˆé¿å…æœªæ¥å‡½æ•°ï¼‰
//
// ä½¿ç”¨è¯´æ˜Žï¼š
// - å¼ åŠ› > é˜ˆå€¼ï¼šè¶…ä¹°åŒºåŸŸ
// - å¼ åŠ› < -é˜ˆå€¼ï¼šè¶…å–åŒºåŸŸ
// - å¼ åŠ›æ‹å¤´å‘ä¸Šï¼šä¹°å…¥ä¿¡å·
// - å¼ åŠ›æ‹å¤´å‘ä¸‹ï¼šå–å‡ºä¿¡å·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”§ å‚æ•°è®¾ç½®
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// çª—å£å‚æ•°
windowSize = input.int(200, "çª—å£å¤§å°ï¼ˆäº¤æ˜“æ—¥ï¼‰", minval=50, maxval=500, group="çª—å£è®¾ç½®")
smoothPeriod = input.int(20, "å¹³æ»‘å‘¨æœŸ", minval=5, maxval=50, group="å¹³æ»‘è®¾ç½®")

// å¼ åŠ›å‚æ•°
tensionThreshold = input.float(1.6, "å¼ åŠ›é˜ˆå€¼", minval=0.5, maxval=3.0, step=0.1, group="å¼ åŠ›è®¾ç½®")
useNormalized = input.bool(true, "ä½¿ç”¨æ ‡å‡†åŒ–å¼ åŠ›", group="å¼ åŠ›è®¾ç½®")

// æ˜¾ç¤ºé€‰é¡¹
showTension = input.bool(true, "æ˜¾ç¤ºå¼ åŠ›æ›²çº¿", group="æ˜¾ç¤ºé€‰é¡¹")
showSignals = input.bool(true, "æ˜¾ç¤ºä¹°å–ä¿¡å·", group="æ˜¾ç¤ºé€‰é¡¹")
showHistogram = input.bool(true, "æ˜¾ç¤ºå¼ åŠ›æŸ±çŠ¶å›¾", group="æ˜¾ç¤ºé€‰é¡¹")
showPanel = input.bool(true, "æ˜¾ç¤ºä¿¡æ¯é¢æ¿", group="æ˜¾ç¤ºé€‰é¡¹")

// é¢œè‰²è®¾ç½®
colorBuy = input.color(color.new(color.green, 0), "ä¹°å…¥ä¿¡å·é¢œè‰²", group="é¢œè‰²è®¾ç½®")
colorSell = input.color(color.new(color.red, 0), "å–å‡ºä¿¡å·é¢œè‰²", group="é¢œè‰²è®¾ç½®")
colorOverbought = input.color(color.new(color.red, 80), "è¶…ä¹°åŒºåŸŸé¢œè‰²", group="é¢œè‰²è®¾ç½®")
colorOversold = input.color(color.new(color.green, 80), "è¶…å–åŒºåŸŸé¢œè‰²", group="é¢œè‰²è®¾ç½®")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“ˆ æ ¸å¿ƒè®¡ç®—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 1. å¯¹æ•°æ”¶ç›ŠçŽ‡ï¼ˆæ ‡å‡†åŒ–ä»·æ ¼å˜åŒ–ï¼‰
logReturn = math.log(close / close[1])

// 2. ç´¯ç§¯å¯¹æ•°æ”¶ç›Šï¼ˆæ¨¡æ‹ŸåŽ»è¶‹åŠ¿åŽçš„ä»·æ ¼ï¼‰
// Pine Script æ²¡æœ‰ ta.cumsumï¼Œä½¿ç”¨ ta.sum æ»šåŠ¨è®¡ç®—
var float cumLogReturn = 0.0
cumLogReturn := cumLogReturn + logReturn

// 3. å¤šå±‚å¹³æ»‘ï¼ˆæ¨¡æ‹Ÿ FFT çš„é¢‘åŸŸæ»¤æ³¢ï¼‰
// ä½¿ç”¨ä¸åŒå‘¨æœŸçš„ EMA æ¨¡æ‹Ÿæå–ä¸åŒé¢‘çŽ‡æˆåˆ†
emaFast = ta.ema(cumLogReturn, math.round(smoothPeriod / 4))
emaMid = ta.ema(cumLogReturn, smoothPeriod)
emaSlow = ta.ema(cumLogReturn, smoothPeriod * 2)

// 4. åˆæˆä¿¡å·ï¼ˆæ¨¡æ‹Ÿ Top N é¢‘çŽ‡é‡æž„ï¼‰
reconstructed = emaFast * 0.5 + emaMid * 0.3 + emaSlow * 0.2

// 5. è®¡ç®—å˜åŒ–çŽ‡ï¼ˆæ¨¡æ‹Ÿ Hilbert å˜æ¢çš„è™šéƒ¨ï¼‰
delta = reconstructed - reconstructed[1]
delta2 = delta - delta[1]

// 6. è®¡ç®—åŽŸå§‹å¼ åŠ›ï¼ˆåŠ¨é‡ + äºŒé˜¶å¯¼æ•°ï¼‰
rawTension = delta + delta2 * 0.5

// 7. æ ‡å‡†åŒ–ï¼ˆé™¤ä»¥æ»šåŠ¨æ ‡å‡†å·®ï¼‰
if useNormalized
    std = ta.stdev(rawTension, windowSize)
    tension = rawTension / (std != 0 ? std : 1)
else
    tension := rawTension

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸŽ¯ ä¿¡å·ç”Ÿæˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ£€æµ‹æ‹ç‚¹
prevTension = tension[1]
tensionIncreasing = tension > prevTension
tensionDecreasing = tension < prevTension

// è¶…ä¹°/è¶…å–çŠ¶æ€
overbought = tension > tensionThreshold
oversold = tension < -tensionThreshold
extremeOverbought = tension > tensionThreshold * 1.5
extremeOversold = tension < -tensionThreshold * 1.5

// ä¹°å…¥ä¿¡å·ï¼šä»Žè¶…å–åŒºåŸŸæ‹å¤´å‘ä¸Š
buySignal = oversold[1] and tensionIncreasing and not oversold

// å–å‡ºä¿¡å·ï¼šä»Žè¶…ä¹°åŒºåŸŸæ‹å¤´å‘ä¸‹
sellSignal = overbought[1] and tensionDecreasing and not overbought

// æžç«¯ä¿¡å·
extremeBuy = extremeOversold[1] and tensionIncreasing
extremeSell = extremeOverbought[1] and tensionDecreasing

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“Š å¯è§†åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ç»˜åˆ¶å¼ åŠ›æ›²çº¿
plot(showTension ? tension : na, "å¼ åŠ›", color=color.blue, linewidth=2)

// é˜ˆå€¼çº¿
hline(tensionThreshold, "è¶…ä¹°é˜ˆå€¼", color=color.red, linestyle=hline.style_dashed)
hline(-tensionThreshold, "è¶…å–é˜ˆå€¼", color=color.green, linestyle=hline.style_dashed)
hline(0, "é›¶è½´", color=color.gray, linestyle=hline.style_dotted)

// èƒŒæ™¯è‰²å¸¦ï¼ˆæžç«¯åŒºåŸŸï¼‰
bgcolor(extremeOverbought ? colorOverbought : extremeOversold ? colorOversold : na)

// æŸ±çŠ¶å›¾ï¼ˆå¯é€‰ï¼‰
plot(showHistogram and showTension ? tension : na, "å¼ åŠ›æŸ±", style=plot.style_columns, color=tension > 0 ? color.red : color.green)

// ä¿¡å·æ ‡æ³¨
if showSignals
    // æ™®é€šä¹°å…¥
    plotshape(buySignal, "ä¹°å…¥", shape.triangleup, location.bottom, colorBuy, size=size.small, text="ä¹°å…¥")

    // æ™®é€šå–å‡º
    plotshape(sellSignal, "å–å‡º", shape.triangledown, location.top, colorSell, size=size.small, text="å–å‡º")

    // æžç«¯ä¹°å…¥
    if extremeBuy
        label.new(bar_index, 0, "â˜…æžç«¯ä¹°å…¥", color=color.new(color.green, 0), textcolor=color.white, style=label.style_label_up, size=size.large)

    // æžç«¯å–å‡º
    if extremeSell
        label.new(bar_index, 0, "â˜†æžç«¯å–å‡º", color=color.new(color.red, 0), textcolor=color.white, style=label.style_label_down, size=size.large)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“‹ ä¿¡æ¯é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if showPanel and barstate.islast
    // åˆ›å»ºä¿¡æ¯è¡¨æ ¼
    var table infoPanel = table.new(position.top_right, 2, 8, bgcolor=color.new(color.white, 5), border_width=1, border_color=color.gray)

    // æ ‡é¢˜
    table.cell(infoPanel, 0, 0, "ç»“æž„å¼ åŠ›æ¨¡åž‹", bgcolor=color.new(color.blue, 20), text_color=color.white, text_size=size.normal, width=200)
    table.merge_cells(infoPanel, 0, 0, 1, 0)

    // å½“å‰å¼ åŠ›
    table.cell(infoPanel, 0, 1, "å½“å‰å¼ åŠ›", text_color=color.black, text_size=size.small)
    tensionText = str.tostring(tension, "#.##")
    tensionColor = tension > tensionThreshold ? color.red : tension < -tensionThreshold ? color.green : color.blue
    table.cell(infoPanel, 1, 1, tensionText, text_color=tensionColor, text_size=size.small)

    // å¸‚åœºçŠ¶æ€
    table.cell(infoPanel, 0, 2, "å¸‚åœºçŠ¶æ€", text_color=color.black, text_size=size.small)
    stateText = extremeOverbought ? "æžåº¦è¶…ä¹°" : extremeOversold ? "æžåº¦è¶…å–" : overbought ? "è¶…ä¹°" : oversold ? "è¶…å–" : "ä¸­æ€§"
    stateColor = extremeOverbought ? color.new(color.red, 0) : extremeOversold ? color.new(color.green, 0) : overbought ? color.new(color.red, 50) : oversold ? color.new(color.green, 50) : color.gray
    table.cell(infoPanel, 1, 2, stateText, text_color=stateColor, text_size=size.small)

    // è¶‹åŠ¿æ–¹å‘
    table.cell(infoPanel, 0, 3, "è¶‹åŠ¿æ–¹å‘", text_color=color.black, text_size=size.small)
    trendText = tensionIncreasing ? "å‘ä¸Š â†—" : tensionDecreasing ? "å‘ä¸‹ â†˜" : "éœ‡è¡ â†’"
    trendColor = tensionIncreasing ? color.green : tensionDecreasing ? color.red : color.gray
    table.cell(infoPanel, 1, 3, trendText, text_color=trendColor, text_size=size.small)

    // ä¿¡å·çŠ¶æ€
    table.cell(infoPanel, 0, 4, "ä¿¡å·çŠ¶æ€", text_color=color.black, text_size=size.small)
    signalText = buySignal[1] ? "ä¹°å…¥ä¿¡å·" : sellSignal[1] ? "å–å‡ºä¿¡å·" : "è§‚æœ›"
    signalColor = buySignal[1] ? color.green : sellSignal[1] ? color.red : color.gray
    table.cell(infoPanel, 1, 4, signalText, text_color=signalColor, text_size=size.small)

    // é˜ˆå€¼è·ç¦»
    table.cell(infoPanel, 0, 5, "é˜ˆå€¼è·ç¦»", text_color=color.black, text_size=size.small)
    thresholdDist = str.tostring(math.abs(tension) / tensionThreshold * 100, "#.#") + "%"
    table.cell(infoPanel, 1, 5, thresholdDist, text_size=size.small)

    // å½“å‰ä»·æ ¼
    table.cell(infoPanel, 0, 6, "å½“å‰ä»·æ ¼", text_color=color.black, text_size=size.small)
    table.cell(infoPanel, 1, 6, str.tostring(close, "#.##"), text_size=size.small)

    // è‚¡ç¥¨ä»£ç 
    table.cell(infoPanel, 0, 7, "è‚¡ç¥¨ä»£ç ", text_color=color.black, text_size=size.small)
    table.cell(infoPanel, 1, 7, syminfo.ticker, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“¡ ä¿¡å·è¾“å‡ºï¼ˆç”¨äºŽ Alertï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å®šä¹‰ä¿¡å·ç±»åž‹ï¼ˆç”¨äºŽ Alertï¼‰
signal = buySignal ? "BUY" : sellSignal ? "SELL" : extremeBuy ? "EXTREME_BUY" : extremeSell ? "EXTREME_SELL" : "NONE"

// ç»˜åˆ¶ä¿¡å·å­—ç¬¦ï¼ˆç”¨äºŽåˆ›å»º Alertï¼‰
plotchar(signal != "NONE", "å¼ åŠ›ä¿¡å·", "â€¢", location.top, size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸš€ Alert é…ç½®æç¤º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// åˆ›å»º Alert æ—¶ï¼š
// 1. æ¡ä»¶ï¼šå¼ åŠ›ä¿¡å· ä¸ç­‰äºŽ "NONE"
// 2. Webhook URL: https://your-server.com/api/structural-tension
// 3. æ¶ˆæ¯æ ¼å¼ï¼š
//    {
//      "ticker": "{{ticker}}",
//      "signal": "{{plot_0}}",
//      "tension": {{plot_1}},
//      "price": {{close}}
//    }
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
