# 🎯 TradingView 完整集成指南

## 📋 系统架构

本系统采用**混合架构**，结合 TradingView 图表能力和 Python 后端 AI 分析能力：

```
┌──────────────────────────────────────────────────────────────┐
│                    TradingView 前端                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Pine Script 技术指标                                   │ │
│  │  - 趋势线通道（自动绘制）                               │ │
│  │  - 多空排列（MA5/10/20/60）                             │ │
│  │  - MACD + KDJ 双共振                                    │ │
│  │  - 狙击点位标注（★理想买点/☆理想卖点）                  │ │
│  │  - 操作检查清单（可视化面板）                           │ │
│  │  - 极端风险警报                                         │ │
│  └────────────────┬───────────────────────────────────────┘ │
│                   │ Alert 触发                                │
│                   ▼                                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Webhook 请求                                           │ │
│  │  /api/analysis?code=AAPL&signal=IDEAL_BUY              │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│                     Python 后端                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  REST API (/api/analysis)                              │ │
│  └────────────────┬───────────────────────────────────────┘ │
│                   │                                           │
│  ┌────────────────┴───────────────────────────────────────┐ │
│  │  StockAnalysisPipeline                                 │ │
│  │  ├─ 技术分析引擎                                        │ │
│  │  ├─ FinBERT 语义分析（新闻情绪）                       │ │
│  │  ├─ 新闻聚合（Tavily/SerpAPI）                         │ │
│  │  └─ 波动率计算                                          │ │
│  └────────────────────────────────────────────────────────┘ │
│                   │                                           │
│  ┌────────────────┴───────────────────────────────────────┐ │
│  │  数据源                                                 │ │
│  │  ├─ 中国 A 股（efinance, akshare）                     │ │
│  │  ├─ 国内期货（akshare）                                 │ │
│  │  ├─ 国际市场（yfinance）                                │ │
│  │  └─ 新闻数据（Tavily, SerpAPI）                        │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

---

## 🚀 快速开始

### Step 1: 安装 TradingView 指标

1. **打开 TradingView**
   - 访问 https://www.tradingview.com

2. **打开 Pine Editor**
   - 在图表底部点击 "Pine Editor" 标签

3. **复制代码**
   - 打开文件：`tradingview/StockSniper_Indicator.pine`
   - 全选并复制代码

4. **粘贴并添加到图表**
   - 在 Pine Editor 中粘贴代码
   - 点击 "添加到图表" 按钮

5. **查看效果**
   - 指标会显示在图表上
   - 右上角显示操作检查清单
   - 狙击点位会自动标注（★理想买点、☆理想卖点）

### Step 2: 配置后端 API

后端 API 已经集成到现有系统中，无需额外配置。

**API 端点**：
```
GET https://mystock.zeabur.app/api/analysis?code={股票代码}&signal={信号类型}&price={价格}
```

**参数说明**：
- `code`（必需）：股票代码，如 AAPL、TSLA、000001（平安银行）
- `signal`（可选）：信号类型
  - `IDEAL_BUY` - 理想买点
  - `IDEAL_SELL` - 理想卖点
  - `REVERSAL_BUY` - 反转买点
  - `REVERSAL_SELL` - 反转卖点
- `price`（可选）：当前价格

**返回示例**：
```json
{
  "success": true,
  "code": "AAPL",
  "signal": "IDEAL_BUY",
  "current_price": "150.25",
  "analysis": {
    "trend_analysis": "多头排列，MACD金叉，KDJ处于强势区...",
    "sniper_point": "理想买点：回调至MA20附近，乖离率<2%",
    "operation_advice": "建议买入",
    "checklist": {
      "bullish_arrangement": true,
      "macd_bullish": true,
      "kdj_bullish": true,
      "bias_rate": "1.85%"
    },
    "recommendation": "建议买入",
    "confidence": "高"
  },
  "news_sentiment": {
    "positive": 3,
    "negative": 1,
    "neutral": 2,
    "latest_news": "苹果发布新款iPhone，预售超预期..."
  },
  "risk_alerts": [
    "乖离率接近+5%，注意回调风险"
  ],
  "timestamp": "2025-01-15 14:30:00"
}
```

### Step 3: 配置 TradingView Alert（可选）

如果你想当狙击点位出现时自动触发后端 AI 分析：

1. **创建 Alert**
   - 在 TradingView 图表右上角点击 "Alert" 按钮
   - 或点击右上角的铃铛图标 📡

2. **配置 Alert 条件**
   - **条件**：选择 "狙击信号" 指标
   - **触发条件**：狙击信号 不等于 "NONE"

3. **配置 Webhook（可选）**
   - 勾选 "Webhook URL"
   - 输入：`https://mystock.zeabur.app/api/analysis`
   - 或使用你自己的服务器地址

4. **配置消息格式**
   ```
   {
     "code": "{{ticker}}",
     "signal": "{{plot_0}}",
     "price": {{close}},
     "time": "{{time}}",
     "ma5": {{plot_1}},
     "ma20": {{plot_3}}
   }
   ```

5. **保存 Alert**
   - 点击 "创建" 按钮
   - Alert 会在狙击点位出现时自动触发

---

## 📊 功能说明

### TradingView 端功能

#### 1. 趋势线通道
- **基于 ZigZag 算法**自动识别极值点
- 连接关键高低点形成趋势线
- 支持向上和向下趋势
- **参数**：
  - `ZigZag 偏离%`：极值点识别阈值（默认 5%）
  - `ZigZag 回看周期`：回看K线数量（默认 20）

#### 2. 多空排列判断
- **MA5/10/20/60 四条均线**
- 多头排列：MA5 > MA10 > MA20 > MA60
- 空头排列：MA5 < MA10 < MA20 < MA60
- 颜色标识：
  - 🟢 多头（黄色/橙色/蓝色/紫色）
  - 🔴 空头

#### 3. MACD + KDJ 双共振
- **MACD 参数**：快线 12，慢线 26，信号线 9
- **KDJ 参数**：周期 14
- **双共振判断**：
  - ✅ 双多头：MACD 多头 + KDJ 多头
  - ❌ 双空头：MACD 空头 + KDJ 空头
- **特殊信号**：
  - 金叉共振：MACD 金叉 + KDJ 超卖（<20）
  - 死叉共振：MACD 死叉 + KDJ 超买（>80）

#### 4. 狙击点位标注
- **★理想买点**：
  - 多头排列
  - MACD + KDJ 双多头
  - 乖离率 < 2%
- **☆理想卖点**：
  - 空头排列
  - MACD + KDJ 双空头
  - 乖离率 > 5%
- **🔄反转买点**：
  - 从空头转为多头
  - MACD 金叉 + KDJ 超卖
- **🔄反转卖点**：
  - 从多头转为空头
  - KDJ 超买（>80）

#### 5. 操作检查清单（可视化面板）
显示在图表右上角，包含：
- ✅ 多头排列
- ✅ MACD 多头
- ✅ KDJ 多头
- ✅ MACD+KDJ 双共振
- 📊 乖离率
- 📊 布林带位置
- 📈 当前趋势（多头/空头/震荡）
- 💡 操作建议（买入/卖出/持有/观望）
- 💪 信号强度（0-5分）

#### 6. 极端风险警报
- **极端乖离率**：乖离率 > 8% 或 < -8%
  - 背景变红色
- **布林带突破**：价格突破布林带上下轨
  - 背景变橙色

### 后端 AI 分析功能

#### 1. 技术分析
- 完整的趋势分析
- 支撑位和压力位
- 波动率计算

#### 2. FinBERT 语义分析
- 中文金融新闻情绪分析
- 支持 positive/negative/neutral 三分类
- 基于预训练的 FinBERT 模型

#### 3. 新闻聚合
- Tavily 搜索引擎
- SerpAPI 备用
- Bocha 国内搜索引擎
- 自动去重和摘要

#### 4. 多市场支持
- ✅ 中国 A 股（efinance, akshare, tushare）
- ✅ 国内期货（akshare）
- ✅ 美股（yfinance）
- ✅ 港股（yfinance）

---

## 🎯 使用场景

### 场景 1：纯图表分析（不需要后端）

**适用情况**：
- 只需技术指标
- 不需要新闻情绪
- 国际市场（美股、港股、期货）

**使用方法**：
1. 安装 Pine Script 指标
2. 在图表上查看技术信号
3. 根据操作检查清单做决策

**优点**：
- ✅ 无需网络请求
- ✅ 实时响应
- ✅ 纯图表分析

**缺点**：
- ❌ 无新闻情绪分析
- ❌ 无 AI 驱动建议
- ❌ 不支持 A 股

### 场景 2：技术信号 + AI 分析（推荐）

**适用情况**：
- 需要技术指标和 AI 分析结合
- 需要新闻情绪辅助
- 交易 A 股或国内期货

**使用方法**：
1. 在 TradingView 上查看技术信号
2. 当出现狙击点位时
3. 手动调用 API 或配置 Alert
4. 获取完整的 AI 分析报告

**优点**：
- ✅ 技术面 + 基本面结合
- ✅ FinBERT 新闻情绪分析
- ✅ 支持 A 股和期货
- ✅ AI 驱动建议

**缺点**：
- ⚠️ 需要网络请求
- ⚠️ 依赖后端服务

### 场景 3：自动化监控（高级）

**适用情况**：
- 24/7 监控多个市场
- 自动发现狙击点位
- 自动推送分析报告

**使用方法**：
1. 配置 TradingView Alert
2. 设置 Webhook 到后端 API
3. 后端自动执行分析
4. 可配置邮件/微信/Telegram 通知

**优点**：
- ✅ 完全自动
- ✅ 多市场监控
- ✅ 及时通知

**缺点**：
- ⚠️ 需要配置服务器
- ⚠️ 需要配置通知渠道

---

## 🔧 高级配置

### 自定义指标参数

在 TradingView 图表上点击指标设置，可以调整：

**趋势线参数**：
- `ZigZag 偏离%`：默认 5%，范围 1-20%
- `ZigZag 回看周期`：默认 20，范围 5-50

**均线参数**：
- `快速均线`：默认 5
- `中线均线`：默认 10
- `慢速均线`：默认 20
- `超慢均线`：默认 60

**MACD 参数**：
- `MACD 快线`：默认 12
- `MACD 慢线`：默认 26
- `MACD 信号线`：默认 9

**KDJ 参数**：
- `KDJ 周期`：默认 14

**狙击点位参数**：
- `理想买点乖离率%`：默认 2.0%，范围 0.5-5%
- `理想卖点乖离率%`：默认 5.0%，范围 2-10%

**显示选项**：
- `显示趋势线`：开启/关闭
- `显示狙击点位`：开启/关闭
- `显示检查清单`：开启/关闭
- `显示风险警报`：开启/关闭

### 后端 API 部署

如果你想自己部署后端：

1. **克隆代码**
   ```bash
   git clone https://github.com/iammadma-cryinggun/ASTOCK.git
   cd ASTOCK
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **配置环境变量**
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，填入 API Keys
   ```

4. **启动 WebUI**
   ```bash
   python start_webui.py
   ```

5. **访问 API**
   ```
   http://localhost:8080/api/analysis?code=AAPL
   ```

### 配置通知渠道

后端分析完成后，可以配置多种通知方式：

**邮件通知**（已在系统中实现）：
- 在 `src/config.py` 中配置 SMTP
- 自动发送分析报告到邮箱

**Telegram 通知**（需要开发）：
- 创建 Telegram Bot
- 配置 Webhook
- 发送消息到指定频道

**企业微信通知**（需要开发）：
- 配置企业微信机器人
- 发送卡片消息

---

## 📈 性能优化

### TradingView 端

- **限制计算范围**：只在需要的K线范围内计算指标
- **减少绘制对象**：关闭不需要的趋势线和标注
- **优化参数**：调整 ZigZag 参数减少计算量

### 后端 API

- **缓存分析结果**：相同股票代码短期内不重复分析
- **异步处理**：对于耗时操作使用异步任务队列
- **数据库存储**：保存历史分析记录，避免重复计算

---

## 🐛 故障排查

### 问题 1：指标不显示信号

**原因**：
- 市场波动小，未达到狙击点位条件
- 参数设置过严格

**解决方法**：
- 降低 `理想买点乖离率%` 参数
- 降低 `ZigZag 偏离%` 参数
- 检查操作检查清单看各项条件

### 问题 2：API 返回错误

**原因**：
- 股票代码格式错误
- 后端服务未启动
- 网络连接问题

**解决方法**：
- 检查股票代码格式（AAPL、000001.SZ）
- 检查后端服务状态
- 查看浏览器控制台错误信息

### 问题 3：Alert 不触发

**原因**：
- Alert 条件设置错误
- Webhook URL 配置错误

**解决方法**：
- 检查 Alert 条件：`狙击信号 不等于 "NONE"`
- 检查 Webhook URL 格式
- 查看 TradingView Alert 日志

### 问题 4：后端分析慢

**原因**：
- 新闻搜索耗时
- FinBERT 模型加载慢
- 网络延迟

**解决方法**：
- 减少 `news_count` 参数（搜索新闻数量）
- FinBERT 模型只加载一次（自动缓存）
- 使用更快的搜索引擎

---

## 📚 进阶阅读

### 相关文件

- **Pine Script 指标**：`tradingview/StockSniper_Indicator.pine`
- **后端 API**：`web/handlers.py` - `handle_tradingview_analysis()`
- **路由配置**：`web/router.py` - `/api/analysis`
- **分析引擎**：`src/core/pipeline.py`
- **语义分析**：`src/semantic_router.py`

### 技术文档

- [Pine Script Language Reference](https://www.tradingview.com/pine-script-docs/)
- [TradingView Alert Documentation](https://www.tradingview.com/support/solutions/understanding-alerts/)
- [FinBERT Paper](https://arxiv.org/abs/1908.10063)
- [Stock Analysis Pipeline](../docs/PIPELINE.md)

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

如果你有改进建议或发现了 Bug，请在 GitHub 上创建 Issue。

---

## 📞 支持

如有问题，请：
1. 查看本文档的故障排查部分
2. 在 GitHub 上创建 Issue
3. 查看代码注释

---

## 📄 许可证

MIT License

---

**祝交易顺利！📈💰**
